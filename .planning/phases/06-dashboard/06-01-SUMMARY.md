---
phase: 06-dashboard
plan: 01
subsystem: ui
tags: [tanstack-start, tanstack-router, tanstack-query, react, oat.ink, vite, cors, approval-api]

# Dependency graph
requires:
  - phase: 05-risk-approval-flow
    provides: transitionStatus, getApprovalQueueEntry, approvalQueue schema, agents schema
  - phase: 03-agent-authentication
    provides: requireAuth JWT middleware, agents table with userId
  - phase: 01-foundation
    provides: JWT auth, requireAuth, env config

provides:
  - GET /approvals/pending endpoint (dashboard-facing, JWT auth)
  - PATCH /approvals/:actionId/approve endpoint
  - PATCH /approvals/:actionId/deny endpoint
  - CORS support for localhost frontend dev servers
  - listPendingForUser(userId) service function in approval.service.ts
  - TanStack Start v1.160.2 frontend app at frontend/
  - Login page with email/password form
  - Auth guard layout route redirecting to /login
  - Centralized API client with all 9 backend endpoints
  - oat.ink dark theme with Vercel-style CSS overrides
  - 6 reusable UI primitives (Button, Badge, Card, Spinner, Skeleton, Modal)

affects:
  - 06-dashboard (plan 02 — approval queue UI and services pages depend on these foundations)

# Tech tracking
tech-stack:
  added:
    - "@tanstack/react-start v1.160.2 (TanStack Start framework, Vite-based)"
    - "@tanstack/react-router v1.160.2 (file-based routing with beforeLoad guards)"
    - "@tanstack/react-query v5.90.0 (server state, polling, mutations)"
    - "react v19.0.0 + react-dom (required by TanStack Start bun preset)"
    - "@knadh/oat v0.3.0 (semantic HTML CSS library, dark theme support)"
    - "@use-gesture/react v10.3.1 (swipe gesture detection)"
    - "@react-spring/web v9.7.5 (physics-based card animation)"
    - "vite v7.3.1 (build tool, TanStack Start peer requirement)"
  patterns:
    - "File-based routing via TanStack Router (routes/ directory auto-scanned by Vite plugin)"
    - "Layout route auth guard: _auth.tsx with beforeLoad token check"
    - "routeTree.gen.ts auto-generated by TanStack Start Vite plugin on dev start"
    - "Centralized API client: all backend calls through src/api/endpoints.ts"
    - "CORS: addCorsHeaders wrapper on all backend responses for localhost origins"
    - "Approval route tree: /approvals/pending, /approvals/:id/approve, /approvals/:id/deny"

key-files:
  created:
    - backend/src/routes/dashboard.ts
    - frontend/package.json
    - frontend/vite.config.ts
    - frontend/tsconfig.json
    - frontend/src/router.tsx
    - frontend/src/client.tsx
    - frontend/src/ssr.tsx
    - frontend/src/routes/__root.tsx
    - frontend/src/routes/index.tsx
    - frontend/src/routes/login.tsx
    - frontend/src/routes/_auth.tsx
    - frontend/src/routes/_auth/queue.tsx
    - frontend/src/api/endpoints.ts
    - frontend/src/lib/api-client.ts
    - frontend/src/styles/overrides.css
    - frontend/src/components/primitives/Button.tsx
    - frontend/src/components/primitives/Badge.tsx
    - frontend/src/components/primitives/Card.tsx
    - frontend/src/components/primitives/Spinner.tsx
    - frontend/src/components/primitives/Skeleton.tsx
    - frontend/src/components/primitives/Modal.tsx
    - frontend/src/components/primitives/index.ts
  modified:
    - backend/src/services/approval.service.ts (added listPendingForUser, added agents import)
    - backend/src/server.ts (added dashboard routes, CORS support, addCorsHeaders wrapper)

key-decisions:
  - "TanStack Start v1.160.2 uses vite.config.ts (not app.config.ts) — migrated from Vinxi to Vite at v1.121"
  - "oat.ink package is @knadh/oat v0.3.0 (not v1.x) — latest available version differs from research estimate"
  - "CSS import path: @knadh/oat/oat.min.css (root of package, not /dist/)"
  - "CORS added to all backend routes (not just approval routes) for consistent frontend dev experience"
  - "listPendingForUser orders by createdAt ASC (oldest first) — natural queue processing order"
  - "routeTree.gen.ts auto-generated by plugin on first vite dev run — placeholder committed, overwritten on startup"

patterns-established:
  - "Pattern: Backend ownership check via agents.userId join (not separate query) — avoids N+1"
  - "Pattern: Auth guard via _auth.tsx layout route, not per-route checks"
  - "Pattern: All API calls through centralized api object in endpoints.ts"
  - "Pattern: CORS wrapper function wraps all response paths in handleRequest"

requirements-completed:
  - DASH-01
  - DASH-02

# Metrics
duration: 18min
completed: 2026-02-17
---

# Phase 06 Plan 01: Backend Dashboard Endpoints + Frontend Scaffolding Summary

**Three dashboard approval endpoints (GET/PATCH), CORS support, TanStack Start v1.160.2 frontend with oat.ink dark theme, auth guard, centralized API client, and 6 reusable UI primitives**

## Performance

- **Duration:** 18 min
- **Started:** 2026-02-17T13:16:27Z
- **Completed:** 2026-02-17T13:34:15Z
- **Tasks:** 2
- **Files modified:** 24

## Accomplishments

- Backend: Added `listPendingForUser()` (joins approvalQueue+agents by userId), three dashboard endpoints (GET /approvals/pending, PATCH /approvals/:id/approve, PATCH /approvals/:id/deny), and CORS support for all backend routes
- Frontend: Scaffolded TanStack Start v1.160.2 with Vite, oat.ink dark theme, login page, auth guard (_auth.tsx beforeLoad), centralized API client with 9 endpoints, and 6 primitive components
- TypeScript compiles cleanly in both backend (no new errors) and frontend (zero errors)

## Task Commits

Each task was committed atomically:

1. **Task 1: Backend dashboard approval endpoints** - `a8836c1` (feat)
2. **Task 2: Frontend scaffolding with TanStack Start, auth, API client, and primitives** - `43a5360` (feat)

## Files Created/Modified

- `backend/src/routes/dashboard.ts` — Three handlers: handleListPendingApprovals, handleApproveAction, handleDenyAction
- `backend/src/services/approval.service.ts` — Added listPendingForUser (Drizzle innerJoin approvalQueue+agents by userId)
- `backend/src/server.ts` — Dashboard routes wired, addCorsHeaders wrapper on all responses, OPTIONS preflight
- `frontend/package.json` — TanStack Start, React 19, oat.ink, use-gesture, react-spring dependencies
- `frontend/vite.config.ts` — Vite config with tanstackStart() plugin and vite-tsconfig-paths
- `frontend/src/routes/__root.tsx` — Root layout: oat.ink CSS import, QueryClientProvider, data-theme=dark
- `frontend/src/routes/login.tsx` — Login page with email/password form, error handling, token storage
- `frontend/src/routes/_auth.tsx` — Auth guard layout route with beforeLoad redirect to /login
- `frontend/src/api/endpoints.ts` — Centralized API: BACKEND_BASE, authedFetch, api object with 9 endpoints
- `frontend/src/lib/api-client.ts` — Token management: getStoredToken/setStoredToken/clearStoredToken/isAuthenticated
- `frontend/src/styles/overrides.css` — Vercel dark theme: #000 bg, #0070f3 accent, #222 borders, #ededed text
- `frontend/src/components/primitives/` — Button, Badge, Card, Spinner, Skeleton, Modal + barrel index.ts

## Decisions Made

- **TanStack Start v1.160.2 uses vite.config.ts**: The research noted this might differ — confirmed Vite-based (not Vinxi), `tanstackStart()` is imported from `@tanstack/react-start/plugin/vite`
- **oat.ink v0.3.0**: Latest available version (not v1.x as expected from research) — CSS at `@knadh/oat/oat.min.css`
- **CORS on all routes**: Applied `addCorsHeaders` wrapper to all route responses, not just dashboard routes — ensures consistent browser fetch behavior from frontend dev server
- **Placeholder routeTree.gen.ts**: Committed a stub that gets overwritten by the Vite plugin on first `bun run dev` — plugin auto-generates the proper typed route tree

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] oat.ink version and CSS import path differ from research**
- **Found during:** Task 2 (package installation)
- **Issue:** Research expected `@knadh/oat@^1.0.5` — only versions 0.1.0, 0.2.0, 0.3.0 exist on npm; CSS path is `oat.min.css` at root (not `dist/oat.min.css`)
- **Fix:** Used `@knadh/oat@^0.3.0`, import path `@knadh/oat/oat.min.css`
- **Files modified:** frontend/package.json, frontend/src/routes/__root.tsx
- **Verification:** bun install resolved correctly; CSS import verified in __root.tsx
- **Committed in:** 43a5360

**2. [Rule 1 - Bug] TanStack Start config format is vite.config.ts only (no app.config.ts)**
- **Found during:** Task 2 (scaffolding)
- **Issue:** Plan suggested `app.config.ts` with `defineConfig` from `@tanstack/react-start/config` — this export doesn't exist in v1.160.2; correct approach is `vite.config.ts` with `tanstackStart()` plugin
- **Fix:** Created `vite.config.ts` with the plugin, removed `app.config.ts`; updated scripts from `vinxi dev` to `vite dev`
- **Files modified:** frontend/vite.config.ts, frontend/package.json
- **Verification:** Dev server starts cleanly with `bun run dev`
- **Committed in:** 43a5360

**3. [Rule 3 - Blocking] Missing sub-packages for TanStack Start required explicit installation**
- **Found during:** Task 2 (TypeScript compilation)
- **Issue:** `@tanstack/react-start` v1.160.2 has dependencies (`@tanstack/react-start-client`, `@tanstack/react-start-server`, `@tanstack/start-client-core`, `@tanstack/start-server-core`) that bun didn't auto-install
- **Fix:** Explicitly installed the 4 missing sub-packages; also upgraded vite to v7.3.1 to satisfy peer dep `>=7.0.0`
- **Files modified:** frontend/package.json
- **Verification:** TypeScript compiles cleanly after installation
- **Committed in:** 43a5360

---

**Total deviations:** 3 auto-fixed (1 version mismatch, 1 config format, 1 missing sub-packages)
**Impact on plan:** All auto-fixes necessary for the framework to work correctly. No scope creep.

## Issues Encountered

- `bun create @tanstack/start@latest` timed out on dependency resolution — created the frontend manually following the research patterns, which is more reliable and faster
- vite peer dependency required v7+ but auto-install got v6 — fixed with explicit `bun add vite@latest`

## Self-Check: PASSED

Files verified:
- FOUND: backend/src/routes/dashboard.ts
- FOUND: backend/src/services/approval.service.ts (listPendingForUser added)
- FOUND: backend/src/server.ts (dashboard routes + CORS)
- FOUND: frontend/src/api/endpoints.ts (BACKEND_BASE + 9 api functions)
- FOUND: frontend/src/routes/__root.tsx (data-theme=dark)
- FOUND: frontend/src/routes/_auth.tsx (beforeLoad auth guard)
- FOUND: All 6 primitives (Button, Badge, Card, Spinner, Skeleton, Modal)

Commits verified:
- a8836c1: feat(06-01): backend dashboard approval endpoints with CORS support
- 43a5360: feat(06-01): frontend scaffolding with TanStack Start, oat.ink dark theme, auth flow, and primitives

## Next Phase Readiness

- Plan 02 (approval queue UI + services management) can now use:
  - `/approvals/pending` backend endpoint for polling
  - `/approvals/:id/approve` and `/deny` for action endpoints
  - `Button`, `Badge`, `Card`, `Spinner`, `Skeleton`, `Modal` primitives
  - Auth guard at `_auth.tsx` — add routes under `_auth/` to get protection automatically
  - `api.listPendingApprovals()`, `api.approveAction()`, `api.denyAction()` already wired
- The queue placeholder page (`_auth/queue.tsx`) is functional but shows basic cards — Plan 02 will replace it with swipe gesture cards

---
*Phase: 06-dashboard*
*Completed: 2026-02-17*
