---
phase: 06-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - frontend/src/routes/_auth/queue.tsx
  - frontend/src/components/approval/SwipeCard.tsx
  - frontend/src/components/approval/ActionCard.tsx
  - frontend/src/components/approval/QueueEmpty.tsx
  - frontend/src/hooks/useApprovalQueue.ts
  - frontend/src/hooks/useApproveAction.ts
  - frontend/src/hooks/useDenyAction.ts
autonomous: true
requirements:
  - DASH-01

must_haves:
  truths:
    - "User sees a list of pending approval cards with intent, method, URL, and risk score"
    - "User can expand a card to see full request details (headers, body, risk explanation)"
    - "User can swipe right to approve a pending action"
    - "User can swipe left to deny a pending action"
    - "User can click approve/deny buttons as desktop fallback"
    - "Approved/denied cards are optimistically removed from the queue"
    - "Queue auto-refreshes every 5 seconds to show new pending actions"
    - "Empty queue shows a friendly empty state"
  artifacts:
    - path: "frontend/src/routes/_auth/queue.tsx"
      provides: "Approval queue page"
      contains: "useApprovalQueue"
    - path: "frontend/src/components/approval/SwipeCard.tsx"
      provides: "Swipeable card with gesture + spring animation"
      contains: "useDrag"
    - path: "frontend/src/components/approval/ActionCard.tsx"
      provides: "Card content with intent, method, URL, risk score, expandable details"
      contains: "risk_score"
    - path: "frontend/src/hooks/useApprovalQueue.ts"
      provides: "TanStack Query hook with 5s polling"
      contains: "refetchInterval"
  key_links:
    - from: "frontend/src/routes/_auth/queue.tsx"
      to: "frontend/src/hooks/useApprovalQueue.ts"
      via: "useApprovalQueue hook"
      pattern: "useApprovalQueue"
    - from: "frontend/src/hooks/useApprovalQueue.ts"
      to: "frontend/src/api/endpoints.ts"
      via: "api.listPendingApprovals"
      pattern: "listPendingApprovals"
    - from: "frontend/src/hooks/useApproveAction.ts"
      to: "frontend/src/api/endpoints.ts"
      via: "api.approveAction with optimistic update"
      pattern: "cancelQueries.*approvals"
    - from: "frontend/src/components/approval/SwipeCard.tsx"
      to: "@use-gesture/react"
      via: "useDrag with horizontal axis lock"
      pattern: "useDrag"
---

<objective>
Approval queue page with swipeable action cards, real-time polling, and optimistic mutations.

Purpose: This is the core DASH-01 feature. Users need to view pending risky actions and approve or deny them with swipe gestures (mobile-first) or button clicks (desktop fallback). Cards show the agent's stated intent prominently, with expandable details for full request inspection.

Output: Working /queue page with swipeable cards, 5-second polling, optimistic removal on approve/deny, and empty state.
</objective>

<execution_context>
@/home/shashank/.claude/get-shit-done/workflows/execute-plan.md
@/home/shashank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-dashboard/06-RESEARCH.md
@.planning/phases/06-dashboard/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TanStack Query hooks for approval queue</name>
  <files>
    frontend/src/hooks/useApprovalQueue.ts
    frontend/src/hooks/useApproveAction.ts
    frontend/src/hooks/useDenyAction.ts
  </files>
  <action>
Create `frontend/src/hooks/useApprovalQueue.ts` following research Pattern 5:
- `useQuery` with queryKey `['approvals', 'pending']`
- `queryFn` calls `api.listPendingApprovals()` from endpoints.ts
- `refetchInterval: 5_000` (5 second poll)
- `refetchIntervalInBackground: false` (pause when tab hidden)
- `select: (data) => data.approvals` to extract array from response wrapper
- Define and export `PendingAction` type matching backend response: `{ action_id: string, agent_name: string, service_id: number, method: string, target_url: string, intent: string, risk_score: number, risk_explanation: string, request_headers: Record<string, string>, request_body: string | null, created_at: string }`

Create `frontend/src/hooks/useApproveAction.ts`:
- `useMutation` calling `api.approveAction(actionId)`
- `onMutate`: cancel in-flight queries with `queryClient.cancelQueries({ queryKey: ['approvals', 'pending'] })`, then optimistically remove the card by filtering it out of the cached data via `queryClient.setQueryData`
- `onError`: revert by calling `queryClient.invalidateQueries({ queryKey: ['approvals', 'pending'] })`
- `onSettled`: invalidate queries to ensure consistency

Create `frontend/src/hooks/useDenyAction.ts`:
- Same pattern as useApproveAction but calls `api.denyAction(actionId)`
- Same optimistic removal and error rollback pattern
  </action>
  <verify>
TypeScript compiles: `cd frontend && bunx tsc --noEmit`. All three hooks export correctly. Verify `refetchInterval` is set: `grep "refetchInterval" frontend/src/hooks/useApprovalQueue.ts`. Verify optimistic update: `grep "cancelQueries" frontend/src/hooks/useApproveAction.ts`.
  </verify>
  <done>
Three TanStack Query hooks: useApprovalQueue (5s polling, background pause), useApproveAction (optimistic removal), useDenyAction (optimistic removal). PendingAction type exported. All compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Swipeable action cards and queue page</name>
  <files>
    frontend/src/components/approval/SwipeCard.tsx
    frontend/src/components/approval/ActionCard.tsx
    frontend/src/components/approval/QueueEmpty.tsx
    frontend/src/routes/_auth/queue.tsx
  </files>
  <action>
Use `frontend-design` skill for ALL components in this task. Vercel-style dark aesthetic throughout.

**SwipeCard.tsx** — following research Pattern 6:
- Props: `onApprove: () => void`, `onDeny: () => void`, `children: React.ReactNode`
- Use `useDrag` from `@use-gesture/react` with `axis: 'x'`, `filterTaps: true`
- Use `useSpring` from `@react-spring/web` for `x`, `rotate`, `opacity`
- Swipe threshold: 100px. When threshold crossed, fly card out (x: +/-500, rotate: +/-15deg, opacity: 0), then call onApprove (right) or onDeny (left) after 300ms
- Below threshold while dragging: card follows finger with slight rotation (mx / 20)
- On release below threshold: spring back to center
- Set `touchAction: 'none'` on animated container to prevent scroll conflicts (per research pitfall #5)
- Visual feedback during drag: green tint/border when dragging right (approve direction), red tint/border when dragging left (deny direction). Intensity proportional to drag distance.
- Wrap in `animated.div` from react-spring

**ActionCard.tsx** — the card content inside SwipeCard:
- Props: `action: PendingAction`, `onApprove: () => void`, `onDeny: () => void`
- Use oat.ink semantic HTML: `<article class="card">` with `<header>`, content area, `<footer>`
- Header: Agent intent displayed prominently as `<h3>`, with Badge showing risk score (danger variant if >= 0.7, warning if >= 0.4, info otherwise)
- Content: HTTP method Badge (GET=info, POST=warning, DELETE/PUT=danger), target URL in monospace
- Expandable details section: toggle button "Show details" / "Hide details". When expanded, show: request headers as `<pre>` block, request body as `<pre>` block, risk explanation text. Use CSS transition for expand/collapse.
- Footer: Two buttons as desktop fallback — "Deny" (danger variant, left) and "Approve" (primary variant, right). These call onDeny/onApprove directly (no swipe needed).
- Mobile hint text: "Swipe right to approve, left to deny" shown below cards on touch devices (detect via `'ontouchstart' in window` or media query)

**QueueEmpty.tsx** — empty state when no pending actions:
- Centered layout with icon/illustration, "All clear" heading, "No pending actions" subtitle
- Clean, minimal, Vercel-style

**queue.tsx** — the main approval queue page:
- Create as TanStack Router file route: `createFileRoute('/_auth/queue')`
- Use `useApprovalQueue()` hook for data
- Loading state: show 3 Skeleton cards
- Error state: show error message with retry button
- Empty state: show QueueEmpty component
- Data state: map over pending actions, render each wrapped in `<SwipeCard onApprove={...} onDeny={...}><ActionCard action={action} /></SwipeCard>`
- Pass `useApproveAction` and `useDenyAction` mutations to swipe/button handlers
- Layout: centered container (max-width ~600px), stacked cards with gap
- Page header: "Approval Queue" with pending count Badge
  </action>
  <verify>
TypeScript compiles: `cd frontend && bunx tsc --noEmit`. Frontend dev server starts: `cd frontend && bun run dev`. Visit /queue (after logging in) — should render the approval queue page. If no pending actions, should show empty state. Verify swipe component exists: `grep "useDrag" frontend/src/components/approval/SwipeCard.tsx`.
  </verify>
  <done>
Approval queue page at /queue with swipeable action cards. Each card shows agent intent prominently, HTTP method, target URL, risk score badge, and expandable details. Swipe right to approve, left to deny (mobile). Button fallback for desktop. 5-second polling. Optimistic removal on approve/deny. Empty state when queue is clear. Skeleton loading state.
  </done>
</task>

</tasks>

<verification>
1. Frontend compiles: `cd frontend && bunx tsc --noEmit`
2. Queue page renders at /queue route
3. SwipeCard uses useDrag with horizontal axis lock and touchAction: none
4. ActionCard shows intent, method badge, URL, risk score badge, expandable details
5. Approve/deny buttons visible as desktop fallback
6. useApprovalQueue polls every 5 seconds
7. Optimistic removal on approve/deny (cancelQueries in onMutate)
8. Empty state renders when no pending actions
</verification>

<success_criteria>
- /queue page shows pending approval cards with intent, method, URL, risk score
- Cards expand to show full request details (headers, body, risk explanation)
- Swipe right approves, swipe left denies (with spring animation)
- Button fallback works for desktop users
- Cards optimistically disappear after approve/deny
- Queue refreshes every 5 seconds
- Empty state shows when no pending actions
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard/06-02-SUMMARY.md`
</output>
