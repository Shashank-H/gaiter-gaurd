# Phase 6.1: Agent Management UI - Research

**Researched:** 2026-02-18
**Domain:** React dashboard pages for agent CRUD, API key reveal UX, service scope selection
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Agent list display
- Card-based layout, one card per agent (consistent with approval queue card pattern)
- Minimal card content: agent name, status indicator, key prefix (e.g., `agt_abc123...`)
- Active agents and revoked agents displayed in separate sections
- Revoked agents section collapsed by default
- CTA card for empty state: centered card with icon + "Create your first agent" button

#### Specific Ideas
- Cards should match the visual style established in Phase 6's approval queue cards
- Key prefix display uses the `agt_` prefix format already established in Phase 3 backend

### Claude's Discretion
- Creation flow and form layout (how the create form is presented, multi-step vs single form)
- One-time API key reveal UX (modal, inline, copy-to-clipboard behavior)
- Service scope selection UI (checkboxes, tags, or other pattern for assigning services)
- Revoke/delete confirmation patterns (dialog style, undo options)
- Card spacing, typography, and hover/click interactions
- Edit agent flow (inline editing vs separate page/modal)

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| DASH-03 | Agent management UI (create agents, view keys, manage scopes) | Backend API is fully implemented; frontend needs: routes, hooks, components. Research identifies exact API shape, existing UI patterns to follow, and recommended UX for discretion areas. |
</phase_requirements>

---

## Summary

Phase 6.1 builds entirely on top of a well-established frontend codebase. The backend agent API is 100% complete with five REST endpoints. All primitive UI components (Card, Button, Badge, Modal, Skeleton, Spinner) already exist in `frontend/src/components/primitives/`. The services section (Phases 6-03) provides the exact template to mirror — a list page with a grid, a create page with a form in a card, and an edit page with a form in a card. The agent management pages follow this same pattern.

The primary novel challenges are: (1) the one-time API key reveal UX on agent creation (show full key in a modal, require explicit copy-and-dismiss, never expose again); (2) the two-section list layout (active agents + collapsed revoked section); and (3) the service scope selection UI during create/edit (checkboxes rendered as tags, fed from the existing `useServices` hook). All three can be built with existing primitives without new dependencies.

The edit flow should be a separate page at `/agents/$id/edit` (matching the services pattern of `/services/$id/edit`) rather than inline editing or a modal, because scope editing requires fetching all available services and presenting a full form. The creation flow should be a single-page form at `/agents/new` with a service scope checklist.

**Primary recommendation:** Mirror the services section patterns exactly. New files: route files for `/agents/`, `/agents/new`, `/agents/$id/edit`; hook file `useAgents.ts`; component files `AgentCard.tsx`, `AgentForm.tsx`, `ApiKeyRevealModal.tsx`. No new dependencies required.

---

## Standard Stack

### Core (already installed, no changes needed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `@tanstack/react-router` | ^1.160.0 | File-based routing | Already in use, `createFileRoute` pattern established |
| `@tanstack/react-query` | ^5.90.0 | Server state, cache, mutations | Already in use; `useQuery` + `useMutation` pattern established |
| `react` | ^19.0.0 | UI rendering | Project standard |
| `@knadh/oat` | ^0.3.0 | CSS design system base | Already providing card/badge/button styles |

### Existing Primitives (use as-is)

| Component | Location | Use For |
|-----------|----------|---------|
| `Button` | `src/components/primitives/Button.tsx` | All action buttons; variants: primary/danger/ghost |
| `Card` | `src/components/primitives/Card.tsx` | Wraps `<article class="card">` with optional header/footer |
| `Badge` | `src/components/primitives/Badge.tsx` | Status indicator (active = success, revoked = danger) |
| `Modal` | `src/components/primitives/Modal.tsx` | API key reveal, revoke confirmation |
| `Skeleton` | `src/components/primitives/Skeleton.tsx` | Loading states |
| `Spinner` | `src/components/primitives/Spinner.tsx` | Inline button loading |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom checklist for service scope | External multi-select library | Overkill; custom checkboxes styled with existing CSS vars is simpler and consistent |
| Modal for create form | Full page route | Modal has scroll issues for long forms; separate route matches existing services pattern |
| Inline edit | Separate edit page | Inline edit is complex with scope reassignment needing service list fetch; separate page is simpler |

**Installation:** No new packages required. All needed libraries are already installed.

---

## Architecture Patterns

### Recommended Project Structure

New files to create (following established patterns):

```
frontend/src/
├── api/
│   └── endpoints.ts              # ADD: agent API methods (listAgents, createAgent, updateAgent, deleteAgent, updateAgentServices)
├── hooks/
│   └── useAgents.ts              # NEW: useAgents, useCreateAgent, useUpdateAgent, useDeleteAgent, useUpdateAgentServices
├── components/
│   └── agents/                   # NEW directory
│       ├── AgentCard.tsx         # NEW: single agent card (active variant)
│       ├── AgentForm.tsx         # NEW: create/edit form with service scope checkboxes
│       └── ApiKeyRevealModal.tsx # NEW: one-time API key display after creation
└── routes/
    └── _auth/
        └── agents/
            ├── index.tsx         # NEW: /agents/ list page (active + revoked sections)
            ├── new.tsx           # NEW: /agents/new create page
            └── $id/
                └── edit.tsx      # NEW: /agents/$id/edit edit page
```

TanStack Router auto-generates `routeTree.gen.ts` when dev server runs — no manual update needed.

### Pattern 1: Route File Structure

**What:** Each route exports a `Route` constant created with `createFileRoute`.
**When to use:** Every new page.

```typescript
// Source: existing pattern in frontend/src/routes/_auth/services/index.tsx
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/_auth/agents/')({
  component: AgentsPage,
});
```

### Pattern 2: TanStack Query Hook File

**What:** A single file exports multiple hooks for one resource domain.
**When to use:** All data-fetching for agents.

```typescript
// Source: existing pattern in frontend/src/hooks/useServices.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '@/api/endpoints';

export interface AgentType {
  id: number;
  name: string;
  keyPrefix: string;           // e.g. "agt_abc12345"
  isActive: boolean;
  lastUsedAt: string | null;
  createdAt: string;
  services: Array<{ id: number; name: string }>;
}

const AGENTS_QUERY_KEY = ['agents'] as const;

export function useAgents() {
  return useQuery({
    queryKey: AGENTS_QUERY_KEY,
    queryFn: () => api.listAgents() as Promise<AgentType[]>,
    select: (data): AgentType[] => {
      if (Array.isArray(data)) return data;
      return [];
    },
  });
}
```

### Pattern 3: Optimistic Mutation (for revoke/delete)

**What:** Cancel in-flight queries, snapshot old data, update cache immediately, revert on error.
**When to use:** Revoke (update isActive) and delete agent.

```typescript
// Source: existing pattern in frontend/src/hooks/useServices.ts (useDeleteService)
export function useDeleteAgent() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: number) => api.deleteAgent(id),
    onMutate: async (id: number) => {
      await queryClient.cancelQueries({ queryKey: AGENTS_QUERY_KEY });
      const previousAgents = queryClient.getQueryData<AgentType[]>(AGENTS_QUERY_KEY);
      queryClient.setQueryData<AgentType[]>(AGENTS_QUERY_KEY, (old) =>
        old ? old.filter((a) => a.id !== id) : []
      );
      return { previousAgents };
    },
    onError: (_err, _id, context) => {
      if (context?.previousAgents) {
        queryClient.setQueryData(AGENTS_QUERY_KEY, context.previousAgents);
      }
    },
    onSettled: () => {
      void queryClient.invalidateQueries({ queryKey: AGENTS_QUERY_KEY });
    },
  });
}
```

### Pattern 4: One-Time API Key Reveal

**What:** After `createAgent` mutation resolves, pass the full API key into a modal. Modal shows key in a `<code>` block with copy-to-clipboard button. User must dismiss to proceed. Key is never stored in component state after dismiss.
**When to use:** Agent creation success only.

```typescript
// Recommended implementation pattern
const [revealedKey, setRevealedKey] = useState<string | null>(null);

const createAgent = useCreateAgent();

function handleSubmit(data: AgentPayload) {
  createAgent.mutate(data, {
    onSuccess: (result) => {
      // result.apiKey is the full key returned only once from POST /agents
      setRevealedKey(result.apiKey);
      // Do NOT navigate yet — user must copy key first
    },
  });
}

function handleKeyModalClose() {
  setRevealedKey(null);
  void navigate({ to: '/agents/' });
}
```

### Pattern 5: Service Scope Checkboxes

**What:** Fetch available services with `useServices()`, render as a list of checkboxes. Each checkbox toggles a service ID in local state `Set<number>`. On form submit, convert to `serviceIds: number[]`.
**When to use:** Create and edit forms.

```typescript
// Recommended implementation
const { data: services } = useServices(); // reuse existing hook
const [selectedServiceIds, setSelectedServiceIds] = useState<Set<number>>(
  new Set(defaultValues?.services?.map((s) => s.id) ?? [])
);

function toggleService(id: number) {
  setSelectedServiceIds((prev) => {
    const next = new Set(prev);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    return next;
  });
}

// Rendered as:
services?.map((service) => (
  <label key={service.id} style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
    <input
      type="checkbox"
      checked={selectedServiceIds.has(service.id)}
      onChange={() => toggleService(service.id)}
    />
    <span style={{ fontSize: '0.875rem', color: '#ededed' }}>{service.name}</span>
  </label>
))
```

### Pattern 6: Two-Section Agent List (Active + Revoked)

**What:** Split the agents array into active and revoked. Render active section always-open; render revoked section collapsed by default using HTML `<details>`/`<summary>` or a React `useState` toggle.
**When to use:** Agents list page.

```typescript
const activeAgents = agents?.filter((a) => a.isActive) ?? [];
const revokedAgents = agents?.filter((a) => !a.isActive) ?? [];

// Collapsed revoked section — use Card with expandable prop or details/summary
const [revokedOpen, setRevokedOpen] = useState(false);
```

### Pattern 7: Copy to Clipboard

**What:** Use the `navigator.clipboard.writeText()` API with a "Copied!" state toggle.
**When to use:** API key reveal modal.

```typescript
const [copied, setCopied] = useState(false);

async function handleCopy() {
  await navigator.clipboard.writeText(apiKey);
  setCopied(true);
  setTimeout(() => setCopied(false), 2000);
}
```

### Anti-Patterns to Avoid

- **Storing full API key in global state or query cache:** The full key comes back only in `createAgent` response. Pass it directly to the reveal modal via local `useState`. Never put it in TanStack Query cache or React context.
- **Navigating before key reveal is dismissed:** User must see and copy the key before navigating away. Block navigation until `handleKeyModalClose()` is called.
- **Making `serviceIds` optional on create:** Backend schema requires `serviceIds` with `min(1)`. Form must validate at least one service is selected.
- **Using string IDs for route params:** Route param is `$id` (string from URL). Always `parseInt(id, 10)` before passing to mutation — see edit page pattern in services.
- **Hard-coding 'active'/'revoked' status text:** Use a `Badge` component: `<Badge variant="success">Active</Badge>` and `<Badge variant="danger">Revoked</Badge>`.

---

## Backend API Reference (HIGH confidence — verified from source)

All endpoints are JWT-authenticated via `Authorization: Bearer <token>` header.

### Endpoints

| Method | Path | Request Body | Response |
|--------|------|-------------|----------|
| GET | `/agents` | — | `AgentType[]` (array direct) |
| POST | `/agents` | `{ name: string, serviceIds: number[] }` | `{ agent: AgentType, apiKey: string }` |
| GET | `/agents/:id` | — | `AgentType` (single, with `updatedAt`) |
| PUT | `/agents/:id` | `{ name?: string, isActive?: boolean }` | `AgentType` (updated) |
| DELETE | `/agents/:id` | — | `{ message: "Agent deleted" }` |
| PUT | `/agents/:id/services` | `{ serviceIds: number[] }` | `{ message: string, services: Array<{id,name}> }` |

### AgentType Shape (from backend response)

```typescript
interface AgentType {
  id: number;
  name: string;
  keyPrefix: string;        // 12-char prefix, e.g. "agt_abc12345" (safe to display)
  isActive: boolean;
  lastUsedAt: string | null; // ISO date string or null
  createdAt: string;         // ISO date string
  services: Array<{ id: number; name: string }>;
}

// Create response (unique — also includes full key):
interface CreateAgentResponse {
  agent: Omit<AgentType, 'lastUsedAt' | 'services'>;
  apiKey: string; // full key returned ONLY here, never retrievable again
}
```

### Validation Rules (backend schema)

- `name`: string, min 3 chars, max 100 chars
- `serviceIds`: array of positive integers, min 1 element required
- Update: at least one field (`name` or `isActive`) must be provided
- `updateAgentServices`: `serviceIds` array min 1

### Revoke vs Delete

| Action | Backend Call | Effect |
|--------|-------------|--------|
| Revoke | `PUT /agents/:id` with `{ isActive: false }` | Soft-delete; agent stays in DB, shows in revoked section |
| Delete | `DELETE /agents/:id` | Hard-delete; agent removed from DB entirely |

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Clipboard copy | Custom execCommand fallback | `navigator.clipboard.writeText()` | Widely supported; handles async; built-in |
| Dialog/modal with focus trap | Custom overlay | Existing `Modal` primitive (native `<dialog>`) | Already handles Escape key, backdrop click, SSR guard |
| Service multi-select | External library (react-select, etc.) | Controlled checkboxes with `useServices()` | No new dependency; services list is small; matches dark theme |
| Form validation | Zod on frontend | Simple `useState` validation (match services pattern) | ServiceForm sets the pattern with manual validation; no Zod on frontend currently |
| Confirm dialog | Browser `window.confirm()` | Existing `Modal` primitive | Already styled; matches existing services delete confirm pattern |

**Key insight:** This codebase has zero frontend form libraries and uses controlled React state with manual validation everywhere. Follow this pattern.

---

## Common Pitfalls

### Pitfall 1: routeTree.gen.ts Not Updated After New Route File

**What goes wrong:** Adding a new route file but routeTree.gen.ts doesn't include it — TanStack Router's file-based routing misses the route.
**Why it happens:** routeTree.gen.ts is auto-generated by the router plugin at dev server startup or build time.
**How to avoid:** After creating new route files, restart the dev server. The file will be regenerated automatically. Do NOT manually edit routeTree.gen.ts.
**Warning signs:** TypeScript errors like "Route not found" or navigation to the new route renders a 404.

### Pitfall 2: parseInt on Route Params

**What goes wrong:** Passing `params.id` (string) directly to API calls that expect `number`.
**Why it happens:** URL params are always strings. Backend schema expects `z.number().int().positive()`.
**How to avoid:** Always `const agentId = parseInt(id, 10)` before mutations. Validate `isNaN(agentId)` and show error if invalid.
**Warning signs:** 400 errors from backend, backend "Invalid agent ID" error.

### Pitfall 3: Full API Key Stored in Query Cache

**What goes wrong:** Putting `apiKey` from the create response into TanStack Query cache or component state beyond the reveal modal.
**Why it happens:** Treating create response like a normal entity query.
**How to avoid:** The create mutation's `onSuccess` receives `result.apiKey`. Pass it to a `useState` variable that feeds the reveal modal. When modal closes, set state to `null`. Never cache `apiKey`.
**Warning signs:** `apiKey` appearing in DevTools React state tree, or `apiKey` being refetchable.

### Pitfall 4: Empty serviceIds Submitted

**What goes wrong:** User creates agent without selecting any service — backend returns 400 with validation error.
**Why it happens:** Checkbox list starts unchecked and user submits without selecting.
**How to avoid:** Validate in `handleSubmit`: `if (selectedServiceIds.size === 0) return setErrors({ serviceIds: 'Select at least one service.' })`.
**Warning signs:** Backend 400 response "at least 1" validation message.

### Pitfall 5: Revoke Mutation Caching

**What goes wrong:** Revoking an agent doesn't update the active/revoked split immediately.
**Why it happens:** Without optimistic update, the list doesn't re-split until query invalidation completes.
**How to avoid:** Use optimistic mutation: update `isActive` to `false` in cache immediately, revert on error. Follow the `useDeleteService` optimistic pattern but for field update instead of removal.
**Warning signs:** Agent stays in "Active" section briefly after revoke button click.

### Pitfall 6: Services Not Loaded When AgentForm Renders

**What goes wrong:** Checkbox list shows empty or renders before services are fetched.
**Why it happens:** `useServices()` is async and may not be cached yet.
**How to avoid:** Show `Skeleton` lines while `useServices().isPending` is true. Disable the submit button while services are loading.
**Warning signs:** Empty checkbox list on first render.

---

## Code Examples

### API Client Extension

```typescript
// Source: existing pattern in frontend/src/api/endpoints.ts
// Add to the `api` object:

listAgents: async (): Promise<AgentType[]> => {
  const res = await authedFetch('/agents');
  return res.json();
},

createAgent: async (data: { name: string; serviceIds: number[] }) => {
  const res = await authedFetch('/agents', {
    method: 'POST',
    body: JSON.stringify(data),
  });
  return res.json() as Promise<{ agent: AgentType; apiKey: string }>;
},

updateAgent: async (id: number, data: { name?: string; isActive?: boolean }) => {
  const res = await authedFetch(`/agents/${id}`, {
    method: 'PUT',
    body: JSON.stringify(data),
  });
  return res.json();
},

deleteAgent: async (id: number) => {
  return authedFetch(`/agents/${id}`, { method: 'DELETE' });
},

updateAgentServices: async (id: number, serviceIds: number[]) => {
  const res = await authedFetch(`/agents/${id}/services`, {
    method: 'PUT',
    body: JSON.stringify({ serviceIds }),
  });
  return res.json();
},
```

### AgentCard Component Skeleton

```typescript
// Source: mirrors frontend/src/components/services/ServiceCard.tsx pattern
// Uses <article class="card"> directly (not the Card primitive) to match ActionCard visual style

export function AgentCard({ agent, onEdit, onRevoke, onDelete }: AgentCardProps) {
  return (
    <article
      className="card"
      style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}
    >
      <header style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: '0.75rem' }}>
        <h3 style={{ margin: 0, fontSize: '0.95rem', fontWeight: 600, color: '#ededed' }}>
          {agent.name}
        </h3>
        <Badge variant={agent.isActive ? 'success' : 'danger'}>
          {agent.isActive ? 'Active' : 'Revoked'}
        </Badge>
      </header>

      <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
        <p style={{ margin: 0, fontFamily: 'monospace', fontSize: '0.8rem', color: '#888' }}>
          {agent.keyPrefix}...
        </p>
        {agent.lastUsedAt && (
          <p style={{ margin: 0, fontSize: '0.75rem', color: '#555' }}>
            Last used {new Date(agent.lastUsedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
          </p>
        )}
        {!agent.lastUsedAt && (
          <p style={{ margin: 0, fontSize: '0.75rem', color: '#555' }}>Never used</p>
        )}
      </div>

      {/* Service scope tags */}
      {agent.services.length > 0 && (
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.375rem' }}>
          {agent.services.map((s) => (
            <span key={s.id} style={{ fontSize: '0.7rem', padding: '0.15em 0.5em', background: '#111', border: '1px solid #222', borderRadius: 4, color: '#888' }}>
              {s.name}
            </span>
          ))}
        </div>
      )}

      <footer style={{ display: 'flex', gap: '0.5rem', paddingTop: '0.5rem', borderTop: '1px solid #1a1a1a', marginTop: 'auto' }}>
        <Button variant="ghost" onClick={onEdit} style={{ flex: 1 }}>Edit</Button>
        {agent.isActive
          ? <Button variant="danger" onClick={onRevoke} style={{ flex: 1 }}>Revoke</Button>
          : <Button variant="danger" onClick={onDelete} style={{ flex: 1 }}>Delete</Button>
        }
      </footer>
    </article>
  );
}
```

### API Key Reveal Modal

```typescript
// ApiKeyRevealModal — shown once after agent creation, never again
// Source: extends existing Modal primitive pattern

export function ApiKeyRevealModal({ apiKey, agentName, open, onClose }: ApiKeyRevealModalProps) {
  const [copied, setCopied] = useState(false);

  async function handleCopy() {
    await navigator.clipboard.writeText(apiKey);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  }

  return (
    <Modal open={open} onClose={onClose} title="Save your API key">
      <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
        <p style={{ margin: 0, fontSize: '0.875rem', color: '#888', lineHeight: 1.6 }}>
          This is the only time the full API key for{' '}
          <strong style={{ color: '#ededed' }}>{agentName}</strong> will be shown.
          Copy it now — it cannot be retrieved later.
        </p>

        <div style={{ background: '#111', border: '1px solid #222', borderRadius: 6, padding: '0.75rem', position: 'relative' }}>
          <code style={{ fontSize: '0.8rem', color: '#ededed', wordBreak: 'break-all', display: 'block', marginRight: '5rem' }}>
            {apiKey}
          </code>
          <Button
            variant="ghost"
            onClick={handleCopy}
            style={{ position: 'absolute', top: '0.5rem', right: '0.5rem', padding: '0.25rem 0.6rem', fontSize: '0.75rem' }}
          >
            {copied ? 'Copied!' : 'Copy'}
          </Button>
        </div>

        <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
          <Button variant="primary" onClick={onClose}>
            I've saved the key
          </Button>
        </div>
      </div>
    </Modal>
  );
}
```

### Nav Bar Extension (add "Agents" link to _auth.tsx)

```typescript
// Source: existing pattern in frontend/src/routes/_auth.tsx
// Add after the Services <li> block:
<li>
  <Link
    to="/agents/"
    style={{
      display: 'inline-flex',
      alignItems: 'center',
      padding: '0.375rem 0.75rem',
      borderRadius: 6,
      fontSize: '0.875rem',
      fontWeight: 500,
      textDecoration: 'none',
      color: isActive('/agents') ? '#ededed' : '#555',
      background: isActive('/agents') ? '#111' : 'transparent',
      border: isActive('/agents') ? '1px solid #222' : '1px solid transparent',
      transition: 'color 0.15s ease, background 0.15s ease, border-color 0.15s ease',
    }}
  >
    Agents
  </Link>
</li>
```

### Agents List Page Structure

```typescript
// frontend/src/routes/_auth/agents/index.tsx
function AgentsPage() {
  const { data: agents, isPending, isError } = useAgents();
  const [revokedOpen, setRevokedOpen] = useState(false);
  const [agentToDelete, setAgentToDelete] = useState<AgentType | null>(null);
  const deleteAgent = useDeleteAgent();
  const revokeAgent = useRevokeAgent(); // useMutation wrapping PUT /agents/:id with { isActive: false }

  const activeAgents = agents?.filter((a) => a.isActive) ?? [];
  const revokedAgents = agents?.filter((a) => !a.isActive) ?? [];

  // empty state, loading, error, then two sections
}
```

---

## State of the Art

| Old Approach | Current Approach | Impact |
|--------------|------------------|--------|
| `app.config.ts` for TanStack Start config | `vite.config.ts` (per Phase 6 decision) | Already correct in this codebase |
| `react-spring` children prop (Phase 6 workaround) | Type cast workaround already applied | No impact on Phase 6.1 which doesn't use react-spring |
| Manual clipboard with `document.execCommand` | `navigator.clipboard.writeText()` (async API) | Modern browsers; no fallback needed for dashboard use case |

---

## Open Questions

1. **Edit agent: update name and services in one request or two?**
   - What we know: `PUT /agents/:id` updates `name` and/or `isActive` only. `PUT /agents/:id/services` updates services only. These are separate endpoints.
   - What's unclear: Whether the edit form should combine them into two sequential API calls or split into two forms.
   - Recommendation: Single edit page with two form sections (details + scope), each saving independently (separate "Save" buttons per section). Matches the services edit page which has separate "Service Details" and "Credentials" sections. Avoids coupling two mutations.

2. **Revoke confirmation pattern**
   - What we know: Revoke is reversible (can set `isActive: true` again). Delete is permanent.
   - What's unclear: Whether revoke needs a confirmation modal (like delete) or can be a simple button.
   - Recommendation: Show a confirmation Modal for both revoke and delete — revoke is a significant action even if reversible. Use `variant="danger"` button in both confirms. Revoke modal text: "Revoke access for [name]? The agent's API key will stop working immediately. You can re-activate later." Delete modal text: "Permanently delete [name]? This cannot be undone."

3. **Re-activate flow**
   - What we know: `PUT /agents/:id` with `{ isActive: true }` re-activates a revoked agent. The revoked section shows cards.
   - What's unclear: Whether revoked agent cards need a "Re-activate" button in addition to "Delete".
   - Recommendation: Yes, add "Re-activate" (ghost variant) and "Delete" (danger) buttons to revoked agent cards. Revoke is soft-delete by design.

---

## Sources

### Primary (HIGH confidence)

- Backend source: `/home/shashank/personal/gaiter-gaurd/backend/src/routes/agents.ts` — exact endpoint methods and response shapes
- Backend source: `/home/shashank/personal/gaiter-gaurd/backend/src/services/agent.service.ts` — validation schemas, return types, business logic
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/components/services/ServiceCard.tsx` — card component pattern to mirror
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/components/services/ServiceForm.tsx` — form pattern to follow
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/hooks/useServices.ts` — hook pattern including optimistic mutation
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/routes/_auth/services/index.tsx` — list page structure
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/routes/_auth/services/new.tsx` — create page structure
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/routes/_auth/services/$id/edit.tsx` — edit page structure
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/routes/_auth.tsx` — nav bar pattern, auth guard layout
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/api/endpoints.ts` — API client pattern
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/styles/overrides.css` — CSS design tokens (colors, spacing)
- Frontend source: `/home/shashank/personal/gaiter-gaurd/frontend/src/components/primitives/Modal.tsx` — Modal implementation

### Secondary (MEDIUM confidence)

- `navigator.clipboard.writeText()` — MDN Web API, widely supported in all modern browsers used by dashboard users; verified as correct approach for this use case.

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — all libraries verified from package.json, no ambiguity
- Backend API surface: HIGH — verified directly from backend source files
- Architecture: HIGH — direct pattern replication from existing services section
- One-time key reveal UX: HIGH — pattern is clear from requirements and existing Modal primitive
- Pitfalls: HIGH — derived from reading actual codebase code and known constraints

**Research date:** 2026-02-18
**Valid until:** 2026-03-18 (stable codebase patterns; only outdated if major refactor occurs)
