---
phase: 06.1-agent-management-ui
plan: 02
subsystem: ui
tags: [react, tanstack-query, tanstack-router, typescript, modal, form]

# Dependency graph
requires:
  - phase: 06.1-01
    provides: useAgents hooks (useCreateAgent, useUpdateAgent, useUpdateAgentServices), AgentCard, /agents/ list page, api.createAgent/updateAgent/updateAgentServices
  - phase: 06-dashboard
    provides: primitives (Modal, Button, Skeleton, Spinner), oat.ink card styles, useServices hook

provides:
  - ApiKeyRevealModal: one-time API key display modal with copy-to-clipboard and mandatory "I've saved the key" dismiss
  - AgentForm: reusable form with name input and service scope checkboxes (used by create page)
  - /agents/new: create agent page with key reveal flow and post-dismiss navigation
  - /agents/$id/edit: edit agent page with two independent sections (details + scope)

affects:
  - 06.1-03 (agent lifecycle complete, any additional agent features can build on these components)

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "API key stored ONLY in local useState on create page — never put into TanStack Query cache"
    - "Two-section edit page: each section has its own form element and save button, saves independently"
    - "Set<number> for checkbox selection state — add/delete operations preserve immutability"
    - "useEffect to initialize form state from loaded agent data (avoids stale initial values)"
    - "Success feedback: local 'Saved' text with 2-second setTimeout reset (no navigation on save)"

key-files:
  created:
    - frontend/src/components/agents/ApiKeyRevealModal.tsx
    - frontend/src/components/agents/AgentForm.tsx
    - frontend/src/routes/_auth/agents/new.tsx
    - frontend/src/routes/_auth/agents/$id/edit.tsx

key-decisions:
  - "API key stored only in local useState on create page — never in query cache (security requirement)"
  - "Two-section edit page: Agent Details and Service Scope each save independently (matches services edit pattern)"
  - "AgentForm wraps content in <article className='card'> for consistent card appearance with services pattern"
  - "Modal dismiss on create page triggers navigation to /agents (not immediate — user must acknowledge key first)"
  - "Set<number> for selected service IDs — toggle function adds/deletes without mutation"

patterns-established:
  - "Key reveal flow: create success sets local state with apiKey → modal shown → dismiss clears state + navigates"
  - "Independent save sections: separate <form> elements each with own submit handler, loading state, and success feedback"

requirements-completed:
  - DASH-03

# Metrics
duration: 3min
completed: 2026-02-18
---

# Phase 06.1 Plan 02: Agent Create/Edit Pages Summary

**Agent create page with one-time API key modal and edit page with independent Agent Details and Service Scope sections**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-18T06:24:20Z
- **Completed:** 2026-02-18T06:27:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- `ApiKeyRevealModal`: Modal displaying the full API key once after creation, copy-to-clipboard with 2-second "Copied!" feedback, mandatory "I've saved the key" dismiss button
- `AgentForm`: Reusable form with controlled name input (3-100 chars), service scope checkboxes fetched via `useServices()` with Skeleton loading, `Set<number>` toggle state, inline validation errors
- `/agents/new`: Create page with AgentForm, mutation via `useCreateAgent()`, API key stored ONLY in `useState` (never in query cache), modal shown on success, navigate to `/agents` on modal dismiss
- `/agents/$id/edit`: Edit page with two independent sections — "Agent Details" (name via `useUpdateAgent`) and "Service Scope" (checkboxes via `useUpdateAgentServices`), each with own `<form>`, save button with Spinner, and "Saved" success feedback

## Task Commits

Each task was committed atomically:

1. **Task 1: ApiKeyRevealModal and AgentForm components** - `ff0eadb` (feat)
2. **Task 2: Create agent page and edit agent page** - `01b0173` (feat)

## Files Created/Modified

- `frontend/src/components/agents/ApiKeyRevealModal.tsx` - Created: one-time key modal with copy and dismiss
- `frontend/src/components/agents/AgentForm.tsx` - Created: reusable agent form with name + service checkboxes
- `frontend/src/routes/_auth/agents/new.tsx` - Created: agent creation page with key reveal flow
- `frontend/src/routes/_auth/agents/$id/edit.tsx` - Created: agent edit page with independent detail and scope sections

## Decisions Made

- API key passed from mutation success callback directly to `useState` — never enters TanStack Query cache. This is the core security requirement for one-time key visibility.
- Edit page uses two separate `<form>` elements (not a single form) so each section submits independently. Matches the services edit page pattern of "Service Details" + "Credentials" sections.
- `AgentForm` wraps in `<article className="card">` so the create page doesn't need an additional wrapper, matching the services new page pattern.
- Back links use `'/agents' as never` cast (consistent with Plan 01's `'never'` pattern for new route paths) until routeTree.gen.ts regenerates on dev run.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Pre-existing TypeScript errors remain in `_auth.tsx` and `services/$id/edit.tsx` (trailing slash `/services/` and `/agents/` paths). These are out-of-scope pre-existing issues carried over from Phase 06. Not fixed, not introduced by this plan.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Agent lifecycle UI is complete: list (/agents/), create (/agents/new), edit (/agents/$id/edit)
- All DASH-03 write operations fulfilled (create agent, edit name, edit scope)
- Plan 03 can proceed to any remaining agent management features

## Self-Check: PASSED

All files created and commits verified:
- FOUND: frontend/src/components/agents/ApiKeyRevealModal.tsx
- FOUND: frontend/src/components/agents/AgentForm.tsx
- FOUND: frontend/src/routes/_auth/agents/new.tsx
- FOUND: frontend/src/routes/_auth/agents/$id/edit.tsx
- FOUND: commit ff0eadb (feat(06.1-02): ApiKeyRevealModal and AgentForm components)
- FOUND: commit 01b0173 (feat(06.1-02): create agent page and edit agent page)

---
*Phase: 06.1-agent-management-ui*
*Completed: 2026-02-18*
