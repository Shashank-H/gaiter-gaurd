---
phase: 06.1-agent-management-ui
plan: 02
type: execute
wave: 2
depends_on:
  - "06.1-01"
files_modified:
  - frontend/src/components/agents/AgentForm.tsx
  - frontend/src/components/agents/ApiKeyRevealModal.tsx
  - frontend/src/routes/_auth/agents/new.tsx
  - frontend/src/routes/_auth/agents/$id/edit.tsx
autonomous: true
requirements:
  - DASH-03

must_haves:
  truths:
    - "User can create a new agent with a name and at least one service scope selection"
    - "Full API key is displayed once in a modal after creation and never retrievable again"
    - "User can copy the API key to clipboard from the reveal modal"
    - "User can edit an existing agent's name on the edit page"
    - "User can edit an existing agent's service scope associations on the edit page"
    - "Edit page has two independent save sections (details + scope)"
  artifacts:
    - path: "frontend/src/components/agents/AgentForm.tsx"
      provides: "Reusable agent form with name input and service scope checkboxes"
      exports: ["AgentForm"]
    - path: "frontend/src/components/agents/ApiKeyRevealModal.tsx"
      provides: "One-time API key display modal with copy-to-clipboard"
      exports: ["ApiKeyRevealModal"]
    - path: "frontend/src/routes/_auth/agents/new.tsx"
      provides: "Agent creation page"
      contains: "createFileRoute"
    - path: "frontend/src/routes/_auth/agents/$id/edit.tsx"
      provides: "Agent edit page with details and scope sections"
      contains: "createFileRoute"
  key_links:
    - from: "frontend/src/routes/_auth/agents/new.tsx"
      to: "frontend/src/hooks/useAgents.ts"
      via: "useCreateAgent() mutation"
      pattern: "useCreateAgent\\(\\)"
    - from: "frontend/src/routes/_auth/agents/new.tsx"
      to: "frontend/src/components/agents/ApiKeyRevealModal.tsx"
      via: "Modal shown on create success"
      pattern: "<ApiKeyRevealModal"
    - from: "frontend/src/routes/_auth/agents/$id/edit.tsx"
      to: "frontend/src/hooks/useAgents.ts"
      via: "useAgent, useUpdateAgent, useUpdateAgentServices hooks"
      pattern: "useAgent\\("
    - from: "frontend/src/components/agents/AgentForm.tsx"
      to: "frontend/src/hooks/useServices.ts"
      via: "useServices() for checkbox options"
      pattern: "useServices\\(\\)"
---

<objective>
Agent creation page with one-time API key reveal, and edit page with independent details and scope sections.

Purpose: Completes the agent lifecycle UI — users can create agents (with key reveal), edit names and scopes, fulfilling all DASH-03 write operations.
Output: /agents/new page with form and key reveal modal, /agents/$id/edit page with two-section form, reusable AgentForm and ApiKeyRevealModal components.
</objective>

<execution_context>
@/home/shashank/.claude/get-shit-done/workflows/execute-plan.md
@/home/shashank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-agent-management-ui/06.1-RESEARCH.md
@.planning/phases/06.1-agent-management-ui/06.1-01-SUMMARY.md

@frontend/src/hooks/useAgents.ts
@frontend/src/hooks/useServices.ts
@frontend/src/api/endpoints.ts
@frontend/src/components/services/ServiceForm.tsx
@frontend/src/routes/_auth/services/new.tsx
@frontend/src/routes/_auth/services/$id/edit.tsx
@frontend/src/components/primitives/Modal.tsx
@frontend/src/components/primitives/Button.tsx
@frontend/src/components/primitives/Skeleton.tsx
@frontend/src/components/primitives/Spinner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ApiKeyRevealModal and AgentForm components</name>
  <files>
    frontend/src/components/agents/ApiKeyRevealModal.tsx
    frontend/src/components/agents/AgentForm.tsx
  </files>
  <action>
1. Create `frontend/src/components/agents/ApiKeyRevealModal.tsx`:

Follow the research skeleton exactly. Props:
```
interface ApiKeyRevealModalProps {
  apiKey: string;
  agentName: string;
  open: boolean;
  onClose: () => void;
}
```

Implementation:
- Uses existing Modal primitive with `open` and `onClose` props, title "Save your API key"
- Warning text: "This is the only time the full API key for **{agentName}** will be shown. Copy it now -- it cannot be retrieved later."
- Code block: dark background (#111), 1px #222 border, border-radius 6, padding 0.75rem. Display apiKey in `<code>` with word-break: break-all, monospace font, #ededed color.
- Copy button: positioned absolute top-right of code block. Uses `navigator.clipboard.writeText(apiKey)`. Local state `copied` toggles to "Copied!" for 2 seconds via setTimeout.
- Dismiss button: "I've saved the key" primary variant Button at bottom-right. Calls onClose.
- Do NOT add any other close mechanism — user MUST click "I've saved the key" to dismiss. The Modal's own onClose will also call the same handler (for Escape key).

2. Create `frontend/src/components/agents/AgentForm.tsx`:

A reusable form component used by both create and edit pages. Props:
```
interface AgentFormProps {
  defaultName?: string;
  defaultServiceIds?: number[];
  onSubmit: (data: { name: string; serviceIds: number[] }) => void;
  isSubmitting: boolean;
  submitLabel: string;  // "Create Agent" or "Save Changes"
  errors?: Record<string, string>;
}
```

Implementation:
- Name input: controlled via useState, initialized from defaultName or empty string. Label "Agent Name". Validate min 3, max 100 chars on submit.
- Service scope checkboxes: fetch services via `useServices()` hook. Render as vertical list of `<label>` elements with checkbox + service name. Use `Set<number>` state for selected IDs, initialized from defaultServiceIds. Toggle function adds/removes from Set.
- While useServices().isPending, show Skeleton lines for the checkbox area. Disable submit button.
- Validation on submit: name must be 3-100 chars, at least 1 service must be selected. Show inline error messages below each field in red (#ef4444, fontSize 0.8rem).
- Submit button: uses submitLabel text, primary variant, shows Spinner when isSubmitting.
- Form wrapped in a `<article className="card">` with padding for consistency.
- Do NOT use any form library — follow the manual controlled state + validation pattern established in ServiceForm.tsx.
  </action>
  <verify>
TypeScript compilation: `cd /home/shashank/personal/gaiter-gaurd/frontend && npx tsc --noEmit --pretty 2>&1 | head -30` — no errors in new component files.
  </verify>
  <done>
ApiKeyRevealModal displays full API key in a code block with copy-to-clipboard and "I've saved the key" dismiss button. AgentForm renders name input and service scope checkboxes with validation (min 3 chars name, min 1 service). Both components compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agent page and edit agent page</name>
  <files>
    frontend/src/routes/_auth/agents/new.tsx
    frontend/src/routes/_auth/agents/$id/edit.tsx
  </files>
  <action>
1. Create `frontend/src/routes/_auth/agents/new.tsx`:

Follow the services/new.tsx pattern. Route: `createFileRoute('/_auth/agents/new')`.

Page layout (max-width 600px container, centered):
- Header: "Create Agent" h1 + ghost "Back" button linking to `/agents/`
- AgentForm component with submitLabel="Create Agent"
- Local state: `revealedKey: string | null` (initially null)
- On form submit: call `useCreateAgent().mutate(data)` with onSuccess callback that sets `revealedKey = result.apiKey`. Do NOT navigate on success — wait for key reveal.
- Render `<ApiKeyRevealModal>` with open={!!revealedKey}, apiKey={revealedKey}, agentName from form state.
- On modal close (`handleKeyModalClose`): set revealedKey to null, then navigate to `/agents/` using `useNavigate()`.
- Handle mutation errors: show error message above the form.

CRITICAL: Never store the apiKey in query cache. Pass it only through local useState to the modal.

2. Create `frontend/src/routes/_auth/agents/$id/edit.tsx`:

Follow the services/$id/edit.tsx pattern. Route: `createFileRoute('/_auth/agents/$id/edit')`.

Page layout (max-width 600px container):
- Header: "Edit Agent" h1 + ghost "Back" button linking to `/agents/`
- Parse route param: `const { id } = Route.useParams()`, then `const agentId = parseInt(id, 10)`. If NaN, show error.
- Fetch agent: `useAgent(agentId)`. Show Skeleton while loading, error message if failed.

Two independent form sections (each in its own card):

Section 1 — "Agent Details":
- Name input, controlled state initialized from agent.name
- "Save Details" primary Button
- On submit: call `useUpdateAgent().mutate({ id: agentId, data: { name } })`. Validate name 3-100 chars.
- Show success feedback (brief "Saved" text or disable button temporarily) and error handling.

Section 2 — "Service Scope":
- Checkbox list of all services from `useServices()`, pre-checked based on `agent.services.map(s => s.id)`
- "Save Scope" primary Button
- On submit: call `useUpdateAgentServices().mutate({ id: agentId, serviceIds: [...selectedIds] })`. Validate min 1 selected.
- Show success/error feedback.

Each section saves independently with its own submit button — do NOT combine into a single form. This matches the services edit page which has separate "Service Details" and "Credentials" sections.

Show Spinner in each button while its mutation is pending. Disable the other section's button while one is saving (optional, not required).
  </action>
  <verify>
TypeScript compilation: `cd /home/shashank/personal/gaiter-gaurd/frontend && npx tsc --noEmit --pretty 2>&1 | head -30` — no errors.
Build verification: `cd /home/shashank/personal/gaiter-gaurd/frontend && timeout 15 npx vite build 2>&1 | tail -10` — builds without errors (confirms route tree generation).
  </verify>
  <done>
Create page at /agents/new renders AgentForm, shows ApiKeyRevealModal on success with full API key (never cached), then navigates to /agents/ on dismiss. Edit page at /agents/$id/edit shows two independent sections: Agent Details (name update) and Service Scope (checkbox reassignment), each with its own save button. All routes compile and build successfully.
  </done>
</task>

</tasks>

<verification>
- Create flow: /agents/new form validates name (3-100) and services (min 1), calls POST /agents, shows key in modal, navigates to list on dismiss
- Key security: apiKey only in local useState, never in query cache, shown once in modal
- Edit flow: /agents/$id/edit loads agent data, shows two sections with independent saves
- Details section: updates name via PUT /agents/:id
- Scope section: updates services via PUT /agents/:id/services
- Route params: parseInt(id, 10) used before API calls
- All components use existing primitives (Modal, Button, Badge, Skeleton, Spinner)
</verification>

<success_criteria>
1. /agents/new creates an agent and displays the full API key once in a modal with copy-to-clipboard
2. After dismissing the key modal, user is navigated to /agents/ list
3. /agents/$id/edit loads agent data and allows independent name and scope updates
4. Form validation enforces name 3-100 chars and at least 1 service selected
5. No TypeScript errors, Vite builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-agent-management-ui/06.1-02-SUMMARY.md`
</output>
