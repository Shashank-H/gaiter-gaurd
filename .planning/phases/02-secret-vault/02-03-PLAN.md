---
phase: 02-secret-vault
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - backend/src/services/documentation.service.ts
  - backend/src/routes/documentation.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "User can upload an OpenAPI spec (JSON/YAML) for a service via POST /services/:id/docs"
    - "User can add a markdown document for a service"
    - "User can add a documentation URL for a service"
    - "User can list all documentation for a service via GET /services/:id/docs"
    - "User can delete a documentation entry via DELETE /services/:id/docs/:docId"
    - "Only the service owner can manage documentation"
  artifacts:
    - path: "backend/src/services/documentation.service.ts"
      provides: "Documentation CRUD operations"
      exports: ["addDocumentation", "getDocumentationByService", "deleteDocumentation"]
    - path: "backend/src/routes/documentation.ts"
      provides: "Documentation upload and management endpoints"
      exports: ["handleAddDocumentation", "handleListDocumentation", "handleDeleteDocumentation"]
  key_links:
    - from: "backend/src/routes/documentation.ts"
      to: "backend/src/services/service.service.ts"
      via: "ownership verification before doc operations"
      pattern: "getServiceById"
    - from: "backend/src/server.ts"
      to: "backend/src/routes/documentation.ts"
      via: "route registration for /services/:id/docs patterns"
      pattern: "handleAddDocumentation|handleListDocumentation"
---

<objective>
Documentation upload for registered services — OpenAPI specs, markdown, and URLs.

Purpose: Implements VAULT-03 (API documentation upload). Documentation is critical for later phases where the gateway needs to understand API structures for risk assessment.
Output: Documentation CRUD endpoints attached to services.
</objective>

<execution_context>
@/home/shashank/.claude/get-shit-done/workflows/execute-plan.md
@/home/shashank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-secret-vault/02-RESEARCH.md
@.planning/phases/02-secret-vault/02-02-SUMMARY.md
@backend/src/server.ts
@backend/src/db/schema.ts
@backend/src/services/service.service.ts
@backend/src/routes/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Documentation service layer</name>
  <files>backend/src/services/documentation.service.ts</files>
  <action>
Create `backend/src/services/documentation.service.ts`:

1. Define Zod schemas:
   - `addDocUrlSchema`: type literal 'url', title (optional string 1-255), content (string url, max 2048)
   - `addDocMarkdownSchema`: type literal 'markdown', title (optional string 1-255), content (string min 1, max 1_000_000 — ~1MB text limit)
   - `addDocOpenApiSchema`: type literal 'openapi', title (optional string 1-255), content (string min 1, max 1_000_000)
   - `addDocumentationSchema`: discriminated union on 'type' field of the three above schemas

2. `addDocumentation(serviceId, userId, data)`:
   - Call getServiceById(serviceId, userId) from service.service.ts to verify ownership (reuse existing function — it throws NotFoundError if not owner)
   - For 'openapi' type: attempt to JSON.parse the content to verify it's valid JSON. If it fails, try treating as YAML (but for v1, just require JSON — note in the response if it looks like YAML). Actually, keep it simple: accept the content as-is and store it. Validation of OpenAPI specs can be enhanced later.
   - Insert into documentation table with serviceId, type, title, content
   - Return the created documentation entry (id, serviceId, type, title, createdAt)

3. `getDocumentationByService(serviceId, userId)`:
   - Verify ownership via getServiceById
   - Select all documentation where serviceId matches
   - For 'url' type: return content as-is
   - For 'markdown' and 'openapi': return content as-is (full text)
   - Return array of documentation entries

4. `deleteDocumentation(serviceId, docId, userId)`:
   - Verify service ownership via getServiceById
   - Delete documentation where id = docId AND serviceId matches
   - If no rows deleted, throw NotFoundError('Documentation not found')
   - Return { deleted: true }

Note: For v1, accept content as text via JSON body. File upload (multipart FormData) is a nice-to-have optimization — the JSON body approach works for all three types and is simpler. Users can paste OpenAPI JSON, markdown text, or a URL string.
  </action>
  <verify>TypeScript compilation: `cd backend && bun build src/services/documentation.service.ts --no-bundle --outdir /tmp/check` succeeds.</verify>
  <done>Documentation CRUD service with ownership verification, supports openapi/markdown/url types, content stored as text.</done>
</task>

<task type="auto">
  <name>Task 2: Documentation routes and server wiring</name>
  <files>backend/src/routes/documentation.ts, backend/src/server.ts</files>
  <action>
1. Create `backend/src/routes/documentation.ts`:

   - `handleAddDocumentation(req, params)`: POST /services/:id/docs
     - requireAuth, validateBody with addDocumentationSchema
     - Call addDocumentation(params.id, userId, data)
     - Return 201 with created documentation entry

   - `handleListDocumentation(req, params)`: GET /services/:id/docs
     - requireAuth, parse serviceId from params
     - Call getDocumentationByService(params.id, userId)
     - Return 200 with documentation array

   - `handleDeleteDocumentation(req, params)`: DELETE /services/:id/docs/:docId
     - requireAuth, parse serviceId and docId from params
     - Call deleteDocumentation(params.id, params.docId, userId)
     - Return 200 with { message: 'Documentation deleted' }

   Error handling: same pattern as services.ts — AuthError (401), ValidationError (400), NotFoundError (404), generic (500).

2. Update `backend/src/server.ts` — add documentation route matching:
   ```
   // After existing service routes...
   const docsMatch = pathname.match(/^\/services\/(\d+)\/docs$/);
   if (docsMatch) {
     const params = { id: docsMatch[1] };
     if (method === 'POST') return handleAddDocumentation(req, params);
     if (method === 'GET') return handleListDocumentation(req, params);
   }
   const docDeleteMatch = pathname.match(/^\/services\/(\d+)\/docs\/(\d+)$/);
   if (docDeleteMatch) {
     const params = { id: docDeleteMatch[1], docId: docDeleteMatch[2] };
     if (method === 'DELETE') return handleDeleteDocumentation(req, params);
   }
   ```

   Import the three documentation handlers at top of server.ts.
  </action>
  <verify>
Start server and test with curl:
1. Create a service first (POST /services with credentials)
2. `curl -X POST /services/1/docs -d '{"type":"url","content":"https://api.example.com/docs"}' -H "Content-Type: application/json" -H "Authorization: Bearer ..."` — expect 201
3. `curl -X POST /services/1/docs -d '{"type":"markdown","title":"Setup Guide","content":"# Getting Started\n..."}' ...` — expect 201
4. `curl -X POST /services/1/docs -d '{"type":"openapi","title":"API Spec","content":"{\"openapi\":\"3.0.0\"}"}' ...` — expect 201
5. `curl -X GET /services/1/docs` — expect 200 with 3 documentation entries
6. `curl -X DELETE /services/1/docs/1` — expect 200
7. `curl -X GET /services/1/docs` — expect 200 with 2 entries
8. Try accessing docs for another user's service — expect 404
  </verify>
  <done>Documentation upload endpoints working for all three types (url, markdown, openapi). Ownership enforced. CRUD operations complete. Server routes wired.</done>
</task>

</tasks>

<verification>
1. POST /services/:id/docs accepts type 'url' with a URL string
2. POST /services/:id/docs accepts type 'markdown' with markdown text
3. POST /services/:id/docs accepts type 'openapi' with OpenAPI JSON
4. GET /services/:id/docs returns all documentation for a service
5. DELETE /services/:id/docs/:docId removes a specific document
6. All endpoints require authentication and enforce service ownership
7. Invalid type or missing content returns 400 with Zod error details
</verification>

<success_criteria>
- Three documentation types supported: openapi, markdown, url
- Documentation CRUD works for service owners only
- Validation rejects invalid input with clear error messages
- Documentation stored as text in database
- All endpoints protected by JWT authentication
</success_criteria>

<output>
After completion, create `.planning/phases/02-secret-vault/02-03-SUMMARY.md`
</output>
