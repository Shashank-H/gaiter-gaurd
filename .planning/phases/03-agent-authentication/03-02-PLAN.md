---
phase: 03-agent-authentication
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/src/routes/agents.ts
  - backend/src/middleware/auth.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "Agent requests with valid Agent-Key are accepted"
    - "Agent requests with invalid or missing Agent-Key are rejected with 401"
    - "Agent-Key scope validation ensures agents can only access their authorized services"
    - "User can manage agents via REST API (create, list, get, update, delete, update scopes)"
  artifacts:
    - path: "backend/src/routes/agents.ts"
      provides: "Agent management REST endpoints"
      exports: ["handleCreateAgent", "handleListAgents", "handleGetAgent", "handleUpdateAgent", "handleDeleteAgent", "handleUpdateAgentServices"]
    - path: "backend/src/middleware/auth.ts"
      provides: "Dual auth middleware: JWT for users, API key for agents"
      exports: ["requireAuth", "requireAgentAuth", "requireServiceAccess", "AuthError"]
    - path: "backend/src/server.ts"
      provides: "Server with agent routes wired in"
      contains: "/agents"
  key_links:
    - from: "backend/src/routes/agents.ts"
      to: "backend/src/services/agent.service.ts"
      via: "service function imports"
      pattern: "import.*from.*agent\\.service"
    - from: "backend/src/middleware/auth.ts"
      to: "backend/src/utils/apikey.ts"
      via: "hashApiKey for key validation"
      pattern: "import.*hashApiKey.*from.*apikey"
    - from: "backend/src/middleware/auth.ts"
      to: "backend/src/db/schema.ts"
      via: "agents and agentServices table queries"
      pattern: "agents|agentServices"
    - from: "backend/src/server.ts"
      to: "backend/src/routes/agents.ts"
      via: "route handler imports and URL matching"
      pattern: "import.*from.*routes/agents"
---

<objective>
Add agent management REST API, agent authentication middleware, and wire everything into the server.

Purpose: Expose agent CRUD endpoints for dashboard users and create the requireAgentAuth middleware that validates Agent-Key headers -- the critical authentication path for Phase 4 (Gateway Proxy).
Output: Complete agent management API, dual auth middleware (JWT + Agent-Key), and server routing for /agents endpoints.
</objective>

<execution_context>
@/home/shashank/.claude/get-shit-done/workflows/execute-plan.md
@/home/shashank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-authentication/03-RESEARCH.md
@.planning/phases/03-agent-authentication/03-01-SUMMARY.md
@backend/src/routes/services.ts
@backend/src/middleware/auth.ts
@backend/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add requireAgentAuth and requireServiceAccess to auth middleware</name>
  <files>backend/src/middleware/auth.ts</files>
  <action>
Extend the existing auth.ts middleware file. Keep the existing requireAuth and AuthError as-is. Add two new functions:

1. `requireAgentAuth(req: Request): Promise<{ agentId: number; userId: number }>`:
   - Extract `Agent-Key` header from request
   - If missing, throw AuthError('Missing Agent-Key header', 401)
   - If not starting with 'agt_', throw AuthError('Invalid Agent-Key format', 401)
   - Hash the provided key using hashApiKey from @/utils/apikey
   - Query agents table WHERE keyHash matches, limit 1
   - If no agent found, throw AuthError('Invalid Agent-Key', 401)
   - If agent.isActive is false, throw AuthError('Agent key has been revoked', 401)
   - Fire-and-forget update of lastUsedAt: `db.update(agents).set({ lastUsedAt: new Date() }).where(eq(agents.id, agent.id)).execute().catch(() => {})`
   - Return { agentId: agent.id, userId: agent.userId }

2. `requireServiceAccess(agentId: number, serviceId: number): Promise<void>`:
   - Query agent_services WHERE agentId AND serviceId, limit 1
   - If no row found, throw AuthError('Agent does not have access to this service', 403)

Import: hashApiKey from @/utils/apikey, db from @/config/db, agents and agentServices from @/db/schema, eq and and from drizzle-orm.
  </action>
  <verify>Run `bun run --bun backend/src/middleware/auth.ts` to verify compilation. Confirm exports: requireAuth, requireAgentAuth, requireServiceAccess, AuthError.</verify>
  <done>auth.ts exports requireAgentAuth (validates Agent-Key header, checks isActive, updates lastUsedAt) and requireServiceAccess (checks agent_services join table). Existing requireAuth unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Create agent management routes and wire into server</name>
  <files>backend/src/routes/agents.ts, backend/src/server.ts</files>
  <action>
**Create `backend/src/routes/agents.ts`** following the exact pattern from routes/services.ts:

All endpoints require JWT auth (requireAuth) since these are dashboard/user-facing management endpoints.

1. `handleCreateAgent(req: Request)` - POST /agents
   - requireAuth(req) to get userId
   - validateBody(createAgentSchema)(req)
   - Call createAgent(userId, data)
   - Return 201 with { agent, apiKey } -- NOTE: apiKey is only returned on creation
   - Error handling: AuthError, ValidationError, NotFoundError (invalid serviceIds)

2. `handleListAgents(req: Request)` - GET /agents
   - requireAuth(req)
   - Call getAgentsByUser(userId)
   - Return 200 with array of agents (each includes services array)

3. `handleGetAgent(req: Request, params: { id: string })` - GET /agents/:id
   - requireAuth(req)
   - Parse and validate ID
   - Call getAgentById(agentId, userId)
   - Return 200 with agent detail

4. `handleUpdateAgent(req: Request, params: { id: string })` - PUT /agents/:id
   - requireAuth(req)
   - validateBody(updateAgentSchema)(req)
   - Call updateAgent(agentId, userId, data)
   - Return 200 with updated agent

5. `handleDeleteAgent(req: Request, params: { id: string })` - DELETE /agents/:id
   - requireAuth(req)
   - Call deleteAgent(agentId, userId)
   - Return 200 with { message: 'Agent deleted' }

6. `handleUpdateAgentServices(req: Request, params: { id: string })` - PUT /agents/:id/services
   - requireAuth(req)
   - validateBody(updateAgentServicesSchema)(req)
   - Call updateAgentServices(agentId, userId, data)
   - Return 200 with updated service list

Import from agent.service.ts: createAgent, getAgentsByUser, getAgentById, updateAgent, deleteAgent, updateAgentServices, createAgentSchema, updateAgentSchema, updateAgentServicesSchema, NotFoundError.
Import from middleware: requireAuth, AuthError.
Import from middleware/validation: validateBody, ValidationError.
Import from utils/responses: successResponse, errorResponse.

**Update `backend/src/server.ts`:**
- Import all 6 handlers from @/routes/agents
- Add parameterized route matching for /agents, following the same pattern as /services:

```
// /agents
if (pathname === '/agents') {
  if (method === 'GET') return await handleListAgents(req);
  if (method === 'POST') return await handleCreateAgent(req);
}

// /agents/:id
const agentMatch = pathname.match(/^\/agents\/(\d+)$/);
if (agentMatch) {
  const params = { id: agentMatch[1] };
  if (method === 'GET') return await handleGetAgent(req, params);
  if (method === 'PUT') return await handleUpdateAgent(req, params);
  if (method === 'DELETE') return await handleDeleteAgent(req, params);
}

// /agents/:id/services
const agentServicesMatch = pathname.match(/^\/agents\/(\d+)\/services$/);
if (agentServicesMatch) {
  const params = { id: agentServicesMatch[1] };
  if (method === 'PUT') return await handleUpdateAgentServices(req, params);
}
```

Place the agent routes AFTER the service routes block in the handleRequest function.
  </action>
  <verify>
Run `bun run --bun backend/src/server.ts` to verify compilation. Then start the server with `bun run dev:backend` and test:
1. `curl -s http://localhost:3000/agents` should return 401 (no auth)
2. Register/login to get a JWT, then:
   - `curl -s -H "Authorization: Bearer $TOKEN" http://localhost:3000/agents` should return 200 with empty array
   - Create an agent with a valid serviceId, confirm 201 response includes apiKey field
   - List agents, confirm the new agent appears without apiKey
   - Get agent by ID, confirm detail response
   - Update agent name, confirm 200
   - Delete agent, confirm 200
  </verify>
  <done>Agent management REST API fully functional at /agents with JWT-protected CRUD. Server routes wired with parameterized matching. All 6 endpoints respond correctly. Agent creation returns full API key once. requireAgentAuth middleware is available for Phase 4 proxy routes.</done>
</task>

</tasks>

<verification>
- All agent management endpoints respond behind JWT auth
- POST /agents creates agent and returns full API key exactly once
- GET /agents lists agents without exposing key hash or full key
- PUT /agents/:id updates agent name and/or isActive status
- DELETE /agents/:id removes agent and cascades to agent_services
- PUT /agents/:id/services updates service scope
- requireAgentAuth middleware correctly validates Agent-Key header
- requireServiceAccess middleware correctly validates agent-service scope
- Invalid/missing Agent-Key returns 401
- Revoked agent (isActive=false) returns 401
- Agent accessing unauthorized service returns 403
</verification>

<success_criteria>
- All 6 agent management endpoints return correct HTTP status codes
- Agent creation response includes apiKey field (only time full key is exposed)
- Agent list/get responses include services array but never keyHash or apiKey
- requireAgentAuth validates against hashed keys in database
- requireServiceAccess checks agent_services join table
- Server starts without errors with all new routes registered
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-authentication/03-02-SUMMARY.md`
</output>
